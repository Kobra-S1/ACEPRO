# Please check that [save_variables] is above [ace] if you're using different config
[save_variables]
filename: ~/printer_data/config/saved_variables.cfg

[respond]

[ace]
serial: /dev/ttyACM1
baud: 115200

# Extruder_sensor_pin
# The one immediately after the 4-in-1 splitter output (before the toolhead extruder).
extruder_sensor_pin:PB0

# Toolhead_sensor_pin
# Sensor near the hotend entry at toolhead
toolhead_sensor_pin:nozzle_mcu:PB0

# Default feeding speed, 10-25 in stock
feed_speed: 60
# Default retraction speed, 10-25 in stock
retract_speed: 40
# Length of the retract to make for toolchange
toolchange_retract_length: 900
toolhead_sensor_to_nozzle: 100
toolchange_load_length: 900 #650
# Park to toolhead hit count, default is 5, can be lowered if your setup works stably on lower values
#park_hit_count: 16
max_dryer_temperature: 55
# Disables feed assist after toolchange. Defaults to true
#disable_assist_after_toolchange: true




[gcode_macro CUT_TIP]
description: Cut filament tip at the front-right cutter (Y jab, soft-limit safe)
# --- Tunables ---
variable_x_impact: 261.0        # cutter X
variable_y_impact: 25.0         # cutter Y (near front)
variable_cruise: 200.0          # mm/s (return)
variable_impact: 15.0           # mm/s (push)
variable_y_stroke: 50.0          # mm to push toward front
variable_repeats: 2
variable_dwell_ms: 80
variable_retract: 50.0
# variable_y_dir: -1.0

gcode:
    RESPOND TYPE=echo MSG="CUTTING..."
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    SAVE_GCODE_STATE NAME=ks1_cut_state

    # Compute a safe start Y so start_y - y_stroke >= 0 (with a tiny margin)
    {% set safety = 0.5 %}
    {% set start_y = y_impact if y_impact > (y_stroke + safety) else (y_stroke + safety) %}

    M117 Moving to cutter...
    G90
    G1 X{ x_impact } Y{ start_y } F{ cruise*60 }
    M400

    # Y-axis jabs toward front (front is negative Y)
    G91
    {% for i in range(repeats|int) %}
        G1 Y{ -y_stroke } F{ impact*60 }
        G4 P{ dwell_ms }
        G1 Y{ y_stroke } F{ cruise*60 }
    {% endfor %}
    G90
    M400

    FORCE_MOVE STEPPER=extruder DISTANCE=-{ retract } VELOCITY=10

    M117 CUT DONE
    RESPOND TYPE=echo MSG="CUT DONE"
    RESTORE_GCODE_STATE NAME=ks1_cut_state MOVE=1 MOVE_SPEED=200


[gcode_macro _ACE_PRE_TOOLCHANGE]
variable_purge_temp_min: 240
gcode:
    {action_respond_info("Doing Pre toolchange")}
    SAVE_GCODE_STATE NAME=TOOLCHANGE
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    G91
    G1 Z2 F100                 ; Up Z slightly
    M400

    G90                        ; Return to absolute positioning
    G1 F20000
    G1 Y250
    G1 X40
    G1 Y276
    G1 F6000
    
    M400
    {% if printer.extruder.temperature < purge_temp_min %}
	{% if printer.extruder.target < purge_temp_min %}
          M109 S{purge_temp_min}
        {% else %}
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={purge_temp_min}
        {% endif %}
     {% endif %}

    #G92 E0
    {action_respond_info("Doing Toolchange")}



[gcode_macro _ACE_POST_TOOLCHANGE]
gcode:
    {action_respond_info("Doing Post toolchange")}
    G91
    G1 Z-2 F100                 ; Lower back Z slightly
    M400
    G90                        ; Return to absolute positioning
    #CLEAN NOZZLE
    G1 F20000
    G1 Y250
    G1 X40
    G1 Y276
    G1 F6000
    M400
    RESTORE_GCODE_STATE NAME=TOOLCHANGE MOVE=1 MOVE_SPEED=200

    {action_respond_info("Finish Toolchange")}


[gcode_macro _ACE_ON_EMPTY_ERROR]
gcode:
    {action_respond_info("Spool is empty")}
    {% if printer.idle_timeout.state == "Printing" %}
        PAUSE
    {% endif %}


[gcode_macro TR]
gcode:
    ACE_CHANGE_TOOL TOOL=-1

[gcode_macro T0]
gcode:
    ACE_CHANGE_TOOL TOOL=0

[gcode_macro T1]
gcode:
    ACE_CHANGE_TOOL TOOL=1

[gcode_macro T2]
gcode:
    ACE_CHANGE_TOOL TOOL=2

[gcode_macro T3]
gcode:
    ACE_CHANGE_TOOL TOOL=3

